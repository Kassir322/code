# План реализации изменений для моделей Notification и PaymentLog

## 1. Обновление схемы данных

### 1.1. Обновление модели Notification

- [ ] Добавить поле `type` (enum: payment, refund, receipt, error) - тип уведомления
- [ ] Добавить поле `status` (enum: pending, sent, failed) - статус отправки
- [ ] Добавить поле `channel` (enum: email, sms, telegram) - канал отправки
- [ ] Добавить поле `template` (string) - шаблон уведомления
- [ ] Добавить поле `data` (json) - дополнительные данные для шаблона
- [ ] Добавить поле `retry_count` (integer) - количество попыток отправки
- [ ] Добавить поле `next_retry_at` (datetime) - время следующей попытки
- [ ] Добавить поле `error_message` (text) - сообщение об ошибке

### 1.2. Обновление модели PaymentLog

- [ ] Добавить поле `event_type` (enum: payment_created, payment_succeeded, payment_canceled, refund_created, refund_succeeded, receipt_created) - тип события
- [ ] Добавить поле `yookassa_id` (string) - ID события в ЮKassa
- [ ] Добавить поле `raw_data` (json) - полные данные события
- [ ] Добавить поле `processed` (boolean) - флаг обработки события
- [ ] Добавить поле `processing_error` (text) - ошибка обработки
- [ ] Добавить поле `metadata` (json) - дополнительные метаданные

## 2. Обновление сервисов (SERVICES)

### 2.1. Обновление notification.js

- [ ] Добавить метод `createNotification` для создания уведомления
- [ ] Добавить метод `sendNotification` для отправки уведомления
- [ ] Добавить метод `retryFailedNotifications` для повторной отправки
- [ ] Добавить метод `getNotificationTemplates` для получения шаблонов
- [ ] Добавить метод `processNotificationQueue` для обработки очереди

### 2.2. Обновление payment-log.js

- [ ] Добавить метод `logPaymentEvent` для логирования событий
- [ ] Добавить метод `processPaymentLogs` для обработки логов
- [ ] Добавить метод `getPaymentEvents` для получения событий
- [ ] Добавить метод `cleanupOldLogs` для очистки старых логов

## 3. Обновление контроллеров (CONTROLLERS)

### 3.1. Обновление notification.js

- [ ] Добавить метод `create` для создания уведомления
- [ ] Добавить метод `send` для отправки уведомления
- [ ] Добавить метод `retry` для повторной отправки
- [ ] Добавить метод `list` для получения списка уведомлений

### 3.2. Обновление payment-log.js

- [ ] Добавить метод `create` для создания лога
- [ ] Добавить метод `process` для обработки логов
- [ ] Добавить метод `list` для получения списка логов
- [ ] Добавить метод `cleanup` для очистки старых логов

## 4. Обновление маршрутов (ROUTES)

### 4.1. Обновление notification.js

- [ ] Добавить маршрут `POST /notifications` для создания уведомления
- [ ] Добавить маршрут `POST /notifications/:id/send` для отправки
- [ ] Добавить маршрут `POST /notifications/:id/retry` для повторной отправки
- [ ] Добавить маршрут `GET /notifications` для получения списка

### 4.2. Обновление payment-log.js

- [ ] Добавить маршрут `POST /payment-logs` для создания лога
- [ ] Добавить маршрут `POST /payment-logs/process` для обработки
- [ ] Добавить маршрут `GET /payment-logs` для получения списка
- [ ] Добавить маршрут `DELETE /payment-logs/cleanup` для очистки

## 5. Обновление MIDDLEWARE

### 5.1. Создание middleware для уведомлений

- [ ] Создать middleware `notification-queue.js` для обработки очереди
- [ ] Создать middleware `notification-retry.js` для повторных попыток

### 5.2. Создание middleware для логов

- [ ] Создать middleware `payment-log-processor.js` для обработки логов
- [ ] Создать middleware `payment-log-cleanup.js` для очистки

## 6. Интеграция с ЮKassa

### 6.1. Обработка событий ЮKassa

- [ ] Настроить обработку событий платежей
- [ ] Настроить обработку событий возвратов
- [ ] Настроить обработку событий чеков

### 6.2. Создание уведомлений

- [ ] Создать шаблоны уведомлений для разных событий
- [ ] Настроить отправку уведомлений по разным каналам

## 7. Тестирование

### 7.1. Тестирование уведомлений

- [ ] Тесты создания уведомлений
- [ ] Тесты отправки уведомлений
- [ ] Тесты повторной отправки
- [ ] Тесты шаблонов

### 7.2. Тестирование логов

- [ ] Тесты логирования событий
- [ ] Тесты обработки логов
- [ ] Тесты очистки логов

## 8. Документация

### 8.1. Документация API

- [ ] Документирование новых маршрутов
- [ ] Документирование форматов данных

### 8.2. Внутренняя документация

- [ ] Инструкции по работе с уведомлениями
- [ ] Инструкции по работе с логами

## 9. Развертывание

### 9.1. Миграция данных

- [ ] Создание скриптов миграции
- [ ] Тестирование миграции

### 9.2. Поэтапное развертывание

- [ ] Внедрение новых моделей
- [ ] Настройка обработчиков событий
- [ ] Настройка отправки уведомлений
