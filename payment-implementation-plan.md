# План реализации изменений в платежной системе

## 1. Обновление схемы данных

### 1.1. Обновление модели Payment

- [ ] Добавить поле `receipt_url` (string) для URL чека
- [ ] Добавить поле `refund_status` (enum: none, pending, succeeded, failed) со значением по умолчанию "none"
- [ ] Добавить поле `refund_amount` (decimal) - необязательное, для частичных возвратов
- [ ] Добавить поле `refund_reason` (text) - необязательное
- [ ] Добавить поле `expires_at` (datetime) - срок действия платежа

## 2. Обновление сервисов (SERVICES)

### 2.1. Обновление payment.js

- [ ] Добавить метод `getReceiptUrl(paymentId)` для получения URL чека из ЮKassa
- [ ] Добавить метод `createRefund(paymentId, amount, reason)` для создания возврата
- [ ] Добавить метод `getRefundInfo(refundId)` для получения информации о возврате
- [ ] Обновить метод `createYookassaPayment` для установки срока действия платежа (expires_at)
- [ ] Добавить метод `getYookassaReceipt(paymentId)` для получения чека

## 3. Обновление контроллеров (CONTROLLERS)

### 3.1. Обновление payment.js

- [ ] Обновить метод `create` для установки срока действия платежа
- [ ] Обновить метод `webhook` для обработки событий чеков и возвратов
- [ ] Добавить метод `getReceipt` для получения чека платежа
- [ ] Добавить метод `createRefund` для создания возврата
- [ ] Добавить метод `getRefund` для получения информации о возврате

## 4. Обновление маршрутов (ROUTES)

### 4.1. Обновление payment.js

- [ ] Добавить маршрут для получения чека `GET /payments/:id/receipt`
- [ ] Добавить маршрут для создания возврата `POST /payments/:id/refund`
- [ ] Добавить маршрут для получения информации о возврате `GET /payments/:id/refund`

## 5. Обновление MIDDLEWARE

### 5.1. Создание middleware для проверки статуса платежа

- [ ] Создать middleware `payment-status.js` для проверки статуса платежа перед операциями возврата

## 6. Обновление WEBHOOK-ОБРАБОТЧИКА

### 6.1. Обновление webhook-обработчика

- [ ] Расширить метод `webhook` в контроллере для обработки событий возврата
- [ ] Добавить обработку событий чеков

## 7. Внедрение фронтенд-изменений

### 7.1. Обновление API клиента

- [ ] Добавить методы для работы с чеками и возвратами

### 7.2. Обновление страницы заказа

- [ ] Добавить кнопку для получения чека
- [ ] Добавить интерфейс для создания возврата (только для успешных платежей)

## 8. Тестирование

### 8.1. Создание тестов для новых функций

- [ ] Тесты для возвратов платежей
- [ ] Тесты для получения чеков
- [ ] Тесты для проверки срока действия платежа

### 8.2. Проверка в тестовом режиме ЮKassa

- [ ] Тестирование полного и частичного возврата
- [ ] Тестирование получения чеков
- [ ] Тестирование сроков действия платежей

## 9. Документация

### 9.1. Обновление документации API

- [ ] Документирование новых маршрутов и параметров

### 9.2. Обновление внутренней документации

- [ ] Инструкции для администраторов по работе с возвратами
- [ ] Инструкции по диагностике проблем с платежами

## 10. Развертывание

### 10.1. Миграция данных

- [ ] Создание скрипта для добавления новых полей к существующим платежам

### 10.2. Поэтапное развертывание

- [ ] Сначала внедрить добавление полей и обновление структуры
- [ ] Затем внедрить методы для работы с чеками
- [ ] В последнюю очередь внедрить функциональность возвратов
